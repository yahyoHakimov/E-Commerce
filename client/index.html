<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARKT — Shop</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #faf8f5;
            --bg-card: #ffffff;
            --bg-input: #f5f2ee;
            --border: #e8e4de;
            --border-focus: #2d2a26;
            --text: #2d2a26;
            --text-secondary: #8a8580;
            --text-muted: #b5b0a9;
            --accent: #c45d3e;
            --accent-hover: #a84e34;
            --success: #5a8a6a;
            --error: #c45d3e;
            --radius: 6px;
            --shadow: 0 1px 3px rgba(45,42,38,0.06), 0 4px 12px rgba(45,42,38,0.04);
            --shadow-lg: 0 4px 16px rgba(45,42,38,0.08), 0 12px 40px rgba(45,42,38,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Nav ─────────────────────────────────────── */
        nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.08em;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-user strong { font-weight: 500; }
        .nav-user { font-size: 0.85rem; color: var(--text-secondary); }

        /* ── Buttons ─────────────────────────────────── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.4rem;
            border: none;
            border-radius: var(--radius);
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        .btn-primary { background: var(--text); color: var(--bg); }
        .btn-primary:hover { opacity: 0.85; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-accent:hover { background: var(--accent-hover); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--text); color: var(--text); }
        .btn-danger { background: transparent; color: var(--error); border: 1px solid rgba(196,93,62,0.3); }
        .btn-danger:hover { background: rgba(196,93,62,0.05); }
        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.8rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ── Auth Page ───────────────────────────────── */
        .auth-container {
            min-height: calc(100vh - 57px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card { width: 100%; max-width: 380px; animation: fadeUp 0.5s ease-out; }

        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 600; margin-bottom: 0.5rem; }
        .auth-header p { font-size: 0.9rem; color: var(--text-secondary); }

        .auth-form {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.75rem;
            box-shadow: var(--shadow);
        }

        .auth-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }

        .auth-tab {
            flex: 1; padding: 0.6rem 0; background: none; border: none;
            border-bottom: 2px solid transparent; font-family: 'Outfit', sans-serif;
            font-size: 0.85rem; font-weight: 500; color: var(--text-muted);
            cursor: pointer; transition: all 0.2s;
        }

        .auth-tab.active { color: var(--text); border-bottom-color: var(--text); }

        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block; font-size: 0.78rem; font-weight: 500;
            color: var(--text-secondary); margin-bottom: 0.35rem;
            letter-spacing: 0.03em; text-transform: uppercase;
        }

        .form-group input, .form-group textarea {
            width: 100%; padding: 0.65rem 0.8rem; background: var(--bg-input);
            border: 1px solid transparent; border-radius: var(--radius);
            font-family: 'Outfit', sans-serif; font-size: 0.9rem;
            color: var(--text); outline: none; transition: all 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--border-focus); background: #fff;
        }

        .form-group input::placeholder, .form-group textarea::placeholder { color: var(--text-muted); }
        .form-group textarea { resize: vertical; min-height: 70px; }

        .auth-form .btn { width: 100%; margin-top: 0.5rem; padding: 0.7rem; }

        .auth-footer {
            text-align: center; margin-top: 1.25rem;
            font-size: 0.82rem; color: var(--text-muted);
        }

        .auth-footer a { color: var(--accent); text-decoration: none; }

        /* ── Main Layout ─────────────────────────────── */
        .main-container { max-width: 900px; margin: 0 auto; padding: 2rem 2.5rem; }

        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 600;
        }

        /* ── Product Form Modal ──────────────────────── */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(45, 42, 38, 0.3);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
            animation: fadeIn 0.2s ease-out;
        }

        .modal {
            width: 100%; max-width: 440px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            animation: fadeUp 0.3s ease-out;
        }

        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600;
        }

        .modal-close {
            width: 32px; height: 32px; display: flex; align-items: center;
            justify-content: center; background: none; border: 1px solid var(--border);
            border-radius: var(--radius); cursor: pointer; font-size: 1.1rem;
            color: var(--text-muted); transition: all 0.2s;
        }

        .modal-close:hover { border-color: var(--text); color: var(--text); }

        .form-row { display: flex; gap: 0.75rem; }
        .form-row .form-group { flex: 1; }

        /* ── Products Grid ───────────────────────────── */
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.25rem;
        }

        .product-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 1.25rem; box-shadow: var(--shadow);
            transition: all 0.2s; position: relative;
        }

        .product-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

        .product-img-placeholder {
            width: 100%; aspect-ratio: 4/3; background: var(--bg-input);
            border-radius: var(--radius); margin-bottom: 1rem;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem; font-weight: 600; color: var(--text-muted);
        }

        .product-name { font-weight: 500; font-size: 0.95rem; margin-bottom: 0.25rem; }
        .product-desc { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; line-height: 1.4; }
        .product-price { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 600; color: var(--accent); margin-bottom: 0.25rem; }
        .product-stock { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem; }
        .product-stock.out { color: var(--error); }

        .product-actions { display: flex; gap: 0.5rem; }
        .product-actions .btn { flex: 1; }

        /* ── Cart Badge ──────────────────────────────── */
        .cart-badge { position: relative; cursor: pointer; }
        .cart-count {
            position: absolute; top: -6px; right: -8px;
            background: var(--accent); color: #fff;
            font-size: 0.65rem; font-weight: 600;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .cart-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 0; border-bottom: 1px solid var(--border);
        }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-size: 0.85rem; font-weight: 500; }
        .cart-item-meta { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.15rem; }
        .cart-item-remove {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 1rem; padding: 0.25rem;
            transition: color 0.2s;
        }
        .cart-item-remove:hover { color: var(--error); }

        /* ── Toast ───────────────────────────────────── */
        .toast-container {
            position: fixed; bottom: 1.5rem; right: 1.5rem;
            display: flex; flex-direction: column; gap: 0.5rem; z-index: 200;
        }

        .toast {
            padding: 0.7rem 1rem; border-radius: var(--radius);
            font-size: 0.82rem; font-weight: 500; box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            max-width: 320px;
        }

        .toast.error { background: #fff; border: 1px solid rgba(196,93,62,0.2); color: var(--error); }
        .toast.success { background: #fff; border: 1px solid rgba(90,138,106,0.2); color: var(--success); }

        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        .empty-state p { font-size: 0.9rem; margin-bottom: 1rem; }

        .hidden { display: none !important; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(4px); } }
    </style>
</head>

<body>

    <nav>
        <div class="logo">MARKT</div>
        <div class="nav-right">
            <div class="nav-user hidden" id="navUser">
                <strong id="navUsername"></strong>
            </div>
            <div class="cart-badge hidden" id="navCart" onclick="toggleCart()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 01-8 0"/>
                </svg>
                <span class="cart-count hidden" id="cartCount">0</span>
            </div>
            <button class="btn btn-ghost btn-sm hidden" id="logoutBtn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- ════════ AUTH PAGE ════════ -->
    <div id="authPage" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Welcome</h1>
                <p>Sign in to start shopping</p>
            </div>
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
                    <button class="auth-tab" onclick="switchTab('register')">Create Account</button>
                </div>
                <div class="form-group">
                    <label for="authUsername">Username</label>
                    <input type="text" id="authUsername" placeholder="Enter username">
                </div>
                <div class="form-group hidden" id="emailGroup">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" id="authSubmitBtn" onclick="submitAuth()">Sign In</button>
            </div>
            <div class="auth-footer" id="authFooter">
                Don't have an account? <a href="#" onclick="switchTab('register'); return false;">Create one</a>
            </div>
        </div>
    </div>

    <!-- ════════ MAIN APP ════════ -->
    <div id="appPage" class="hidden">
        <div class="main-container">

            <div class="page-header">
                <h2>Products</h2>
                <button class="btn btn-primary btn-sm" onclick="openProductModal()">+ New Product</button>
            </div>

            <div class="products-grid" id="productsGrid">
                <div class="empty-state"><p>No products yet.</p></div>
            </div>

        </div>
    </div>

    <!-- ════════ PRODUCT MODAL ════════ -->
    <div id="productModal" class="modal-overlay hidden" onclick="if(event.target===this)closeProductModal()">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">New Product</h3>
                <button class="modal-close" onclick="closeProductModal()">×</button>
            </div>
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="productName" placeholder="e.g. Wireless Headphones">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="productDesc" placeholder="Brief product description..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="productStock" placeholder="0" min="0">
                </div>
            </div>
            <button class="btn btn-accent" style="width:100%" id="productSubmitBtn" onclick="submitProduct()">Create Product</button>
        </div>
    </div>

        <!-- ════════ CART SIDEBAR ════════ -->
    <div id="cartOverlay" class="modal-overlay hidden" onclick="if(event.target===this)closeCart()">
        <div class="modal" style="max-width:400px; max-height:80vh; display:flex; flex-direction:column;">
            <div class="modal-header">
                <h3>Your Cart</h3>
                <button class="modal-close" onclick="closeCart()">×</button>
            </div>
            <div id="cartItems" style="flex:1; overflow-y:auto; margin-bottom:1rem;">
                <div class="empty-state"><p>Your cart is empty</p></div>
            </div>
            <div id="cartFooter" class="hidden">
                <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-top:1px solid var(--border); font-size:0.9rem;">
                    <span>Total</span>
                    <strong id="cartTotal">$0.00</strong>
                </div>
                <button class="btn btn-accent" style="width:100%" onclick="checkout()">Checkout</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    /*
    ═══════════════════════════════════════════════════════════════
    CLIENT — Auth + Products CRUD
    ═══════════════════════════════════════════════════════════════
    */

    const state = {
        token: localStorage.getItem("token") || null,
        username: localStorage.getItem("username") || null,
        userId: localStorage.getItem("userId") ? parseInt(localStorage.getItem("userId")) : null,
        authMode: "login",
        products: [],
        editingProductId: null,
        cart: null,
    };

    // ─── API LAYER ────────────────────────────────────────────
    async function api(path, method = "GET", body = null) {
        const headers = { "Content-Type": "application/json" };
        if (state.token) headers["Authorization"] = `Bearer ${state.token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const response = await fetch(path, options);

        // Handle 204 No Content (delete)
        if (response.status === 204) return null;

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Request failed");
        return data;
    }

    // ─── AUTH ─────────────────────────────────────────────────
    function switchTab(mode) {
        state.authMode = mode;
        const tabs = document.querySelectorAll(".auth-tab");
        tabs.forEach(t => t.classList.remove("active"));

        const emailGroup = document.getElementById("emailGroup");
        const btn = document.getElementById("authSubmitBtn");
        const footer = document.getElementById("authFooter");

        if (mode === "register") {
            tabs[1].classList.add("active");
            emailGroup.classList.remove("hidden");
            btn.textContent = "Create Account";
            footer.innerHTML = 'Already have an account? <a href="#" onclick="switchTab(\'login\'); return false;">Sign in</a>';
        } else {
            tabs[0].classList.add("active");
            emailGroup.classList.add("hidden");
            btn.textContent = "Sign In";
            footer.innerHTML = 'Don\'t have an account? <a href="#" onclick="switchTab(\'register\'); return false;">Create one</a>';
        }
    }

    async function submitAuth() {
        const username = document.getElementById("authUsername").value.trim();
        const password = document.getElementById("authPassword").value;
        const email = document.getElementById("authEmail").value.trim();
        // REMOVED: payload line was here — data doesn't exist yet

        if (!username || !password) { showToast("Username and password required", "error"); return; }
        if (state.authMode === "register" && !email) { showToast("Email required", "error"); return; }

        try {
            const btn = document.getElementById("authSubmitBtn");
            btn.disabled = true;

            let data;
            if (state.authMode === "register") {
                data = await api("/auth/register", "POST", { username, email, password });
            } else {
                data = await api("/auth/login", "POST", { username, password });
            }

            // Decode JWT to get user_id — MUST be after data is assigned
            const payload = JSON.parse(atob(data.access_token.split('.')[1]));

            state.token = data.access_token;
            state.username = username;
            state.userId = payload.user_id;
            localStorage.setItem("token", data.access_token);
            localStorage.setItem("username", username);
            localStorage.setItem("userId", payload.user_id);

            showToast(state.authMode === "register" ? "Account created!" : "Welcome back!", "success");
            showApp();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            document.getElementById("authSubmitBtn").disabled = false;
        }
    }

    function logout() {
        state.token = null;
        state.username = null;
        state.userId = null;           // ← null, not payload.user_id
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("userId");
        showAuth();
        showToast("Logged out", "success");
    }

    document.getElementById("authPassword").addEventListener("keydown", e => {
        if (e.key === "Enter") submitAuth();
    });

    // ─── PRODUCTS ─────────────────────────────────────────────
    async function loadProducts() {
        try {
            state.products = await api("/products");
            renderProducts();
        } catch (err) {
            console.error("Failed to load products:", err);
        }
    }

    async function loadCart() {
        try {
            state.cart = await api("/cart");
            updateCartBadge();
        } catch (err) {
            console.log("Cart not loaded:", err);
        }
    }

    function renderProducts() {
        const grid = document.getElementById("productsGrid");

        if (state.products.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <p>No products yet.</p>
                    <button class="btn btn-accent btn-sm" onclick="openProductModal()">Create your first product</button>
                </div>`;
            return;
        }

        grid.innerHTML = state.products.map(p => `
            <div class="product-card">
                <div class="product-img-placeholder">${escapeHtml(p.name.charAt(0).toUpperCase())}</div>
                <div class="product-name">${escapeHtml(p.name)}</div>
                ${p.description ? `<div class="product-desc">${escapeHtml(p.description)}</div>` : ""}
                <div class="product-price">$${p.price.toFixed(2)}</div>
                <div class="product-stock ${p.stock === 0 ? 'out' : ''}">${p.stock > 0 ? p.stock + ' in stock' : 'Out of stock'}</div>
                <div class="product-actions">
                <button class="btn btn-accent btn-sm" onclick="addToCart(${p.id})" ${p.stock === 0 ? 'disabled' : ''}>
                    ${p.stock === 0 ? 'Sold Out' : 'Add to Cart'}
                    </button>
                    ${p.created_by === state.userId ? `
                        <button class="btn btn-ghost btn-sm" onclick="openEditModal(${p.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">×</button>
                    ` : ''}
                </div>
            </div>
        `).join("");
    }

    // ─── PRODUCT MODAL ────────────────────────────────────────
    function openProductModal() {
        state.editingProductId = null;
        document.getElementById("modalTitle").textContent = "New Product";
        document.getElementById("productSubmitBtn").textContent = "Create Product";
        document.getElementById("productName").value = "";
        document.getElementById("productDesc").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("productStock").value = "";
        document.getElementById("productModal").classList.remove("hidden");
    }

    function openEditModal(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;

        state.editingProductId = productId;
        document.getElementById("modalTitle").textContent = "Edit Product";
        document.getElementById("productSubmitBtn").textContent = "Save Changes";
        document.getElementById("productName").value = product.name;
        document.getElementById("productDesc").value = product.description || "";
        document.getElementById("productPrice").value = product.price;
        document.getElementById("productStock").value = product.stock;
        document.getElementById("productModal").classList.remove("hidden");
    }

    function closeProductModal() {
        document.getElementById("productModal").classList.remove("hidden");
        document.getElementById("productModal").classList.add("hidden");
    }

    async function submitProduct() {
        const name = document.getElementById("productName").value.trim();
        const description = document.getElementById("productDesc").value.trim();
        const price = parseFloat(document.getElementById("productPrice").value);
        const stock = parseInt(document.getElementById("productStock").value);

        if (!name) { showToast("Product name is required", "error"); return; }
        if (isNaN(price) || price <= 0) { showToast("Valid price is required", "error"); return; }
        if (isNaN(stock) || stock < 0) { showToast("Valid stock is required", "error"); return; }

        const body = { name, description: description || null, price, stock };

        try {
            const btn = document.getElementById("productSubmitBtn");
            btn.disabled = true;

            if (state.editingProductId) {
                await api(`/products/${state.editingProductId}`, "PUT", body);
                showToast("Product updated", "success");
            } else {
                await api("/products", "POST", body);
                showToast("Product created", "success");
            }

            closeProductModal();
            await loadProducts();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            document.getElementById("productSubmitBtn").disabled = false;
        }
    }

    async function deleteProduct(productId) {
        if (!confirm("Delete this product?")) return;
        try {
            await api(`/products/${productId}`, "DELETE");
            showToast("Product deleted", "success");
            await loadProducts();
        } catch (err) {
            showToast(err.message, "error");
        }
    }

    // Replace these two functions:

    async function addToCart(productId) {
        try {
            const cart = await api("/cart", "POST", { product_id: productId, quantity: 1 });
            state.cart = cart;
            renderCart();
            updateCartBadge();
            showToast("Added to cart", "success");
        } catch (err) {
            showToast(err.message, "error");
        }
    }

    function toggleCart() {
        const overlay = document.getElementById("cartOverlay");
        if (overlay.classList.contains("hidden")) {
            openCart();
        } else {
            closeCart();
        }
    }


    async function openCart() {
        try {
            const cart = await api("/cart");
            state.cart = cart;
            renderCart();
            document.getElementById("cartOverlay").classList.remove("hidden");
        } catch (err) {
            showToast(err.message, "error");
        }
    }

    function closeCart() {
        document.getElementById("cartOverlay").classList.add("hidden");
    }

    function renderCart() {
        const container = document.getElementById("cartItems");
        const footer = document.getElementById("cartFooter");
        const cart = state.cart;

        if (!cart || cart.items.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>Your cart is empty</p></div>';
            footer.classList.add("hidden");
            return;
        }

        container.innerHTML = cart.items.map(item => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${escapeHtml(item.product_name)}</div>
                    <div class="cart-item-meta">$${item.product_price.toFixed(2)} × ${item.quantity} = $${item.subtotal.toFixed(2)}</div>
                </div>
                <button class="cart-item-remove" onclick="removeFromCart(${item.id})">×</button>
            </div>
        `).join("");

        document.getElementById("cartTotal").textContent = `$${cart.total_price.toFixed(2)}`;
        footer.classList.remove("hidden");
    }

    async function removeFromCart(itemId) {
        try {
            const cart = await api(`/cart/${itemId}`, "DELETE");
            state.cart = cart;
            renderCart();
            updateCartBadge();
            showToast("Removed from cart", "success");
        } catch (err) {
            showToast(err.message, "error");
        }
    }

    function updateCartBadge() {
        const badge = document.getElementById("cartCount");
        const count = state.cart ? state.cart.item_count : 0;
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove("hidden");
        } else {
            badge.classList.add("hidden");
        }
    }

    function checkout() {
        showToast("Checkout coming in Slice 4", "success");
    }
    // ─── PAGE SWITCHING ───────────────────────────────────────
    function showAuth() {
        document.getElementById("authPage").classList.remove("hidden");
        document.getElementById("appPage").classList.add("hidden");
        document.getElementById("navUser").classList.add("hidden");
        document.getElementById("navCart").classList.add("hidden");
        document.getElementById("logoutBtn").classList.add("hidden");
    }

    function showApp() {
        document.getElementById("authPage").classList.add("hidden");
        document.getElementById("appPage").classList.remove("hidden");
        document.getElementById("navUser").classList.remove("hidden");
        document.getElementById("navCart").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");
        document.getElementById("navUsername").textContent = state.username;
        loadProducts();
        loadCart();
    }

    // ─── UTILITIES ────────────────────────────────────────────
    function showToast(message, type = "error") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function escapeHtml(str) {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
    }

    // ─── INIT ─────────────────────────────────────────────────
    if (state.token) { showApp(); } else { showAuth(); }
    </script>
</body>
</html>