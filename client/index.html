<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARKT — Shop</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #faf8f5;
            --bg-card: #ffffff;
            --bg-input: #f5f2ee;
            --border: #e8e4de;
            --border-focus: #2d2a26;
            --text: #2d2a26;
            --text-secondary: #8a8580;
            --text-muted: #b5b0a9;
            --accent: #c45d3e;
            --accent-hover: #a84e34;
            --success: #5a8a6a;
            --error: #c45d3e;
            --radius: 6px;
            --shadow: 0 1px 3px rgba(45, 42, 38, 0.06), 0 4px 12px rgba(45, 42, 38, 0.04);
            --shadow-lg: 0 4px 16px rgba(45, 42, 38, 0.08), 0 12px 40px rgba(45, 42, 38, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Nav ─────────────────────────────────────── */
        nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: var(--text);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-user {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .nav-user strong {
            color: var(--text);
            font-weight: 500;
        }

        /* ── Buttons ─────────────────────────────────── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.4rem;
            border: none;
            border-radius: var(--radius);
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        .btn-primary {
            background: var(--text);
            color: var(--bg);
        }

        .btn-primary:hover { opacity: 0.85; }

        .btn-accent {
            background: var(--accent);
            color: #fff;
        }

        .btn-accent:hover { background: var(--accent-hover); }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            border-color: var(--text);
            color: var(--text);
        }

        .btn-sm {
            padding: 0.4rem 0.9rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ── Auth Page ───────────────────────────────── */
        .auth-container {
            min-height: calc(100vh - 57px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            width: 100%;
            max-width: 380px;
            animation: fadeUp 0.5s ease-out;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .auth-form {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.75rem;
            box-shadow: var(--shadow);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            padding: 0.6rem 0;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: var(--text);
            border-bottom-color: var(--text);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .form-group input {
            width: 100%;
            padding: 0.65rem 0.8rem;
            background: var(--bg-input);
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            color: var(--text);
            outline: none;
            transition: all 0.2s;
        }

        .form-group input:focus {
            border-color: var(--border-focus);
            background: #fff;
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .auth-form .btn {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.7rem;
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.25rem;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        /* ── Main Layout (after login) ───────────────── */
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 2.5rem;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* ── Products Grid ───────────────────────────── */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.25rem;
        }

        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .product-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .product-img-placeholder {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-muted);
        }

        .product-name {
            font-weight: 500;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .product-price {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .product-stock {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        /* ── Cart Sidebar ────────────────────────────── */
        .cart-badge {
            position: relative;
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -6px;
            right: -8px;
            background: var(--accent);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ── Toast ───────────────────────────────────── */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 200;
        }

        .toast {
            padding: 0.7rem 1rem;
            border-radius: var(--radius);
            font-size: 0.82rem;
            font-weight: 500;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            max-width: 320px;
            box-shadow: var(--shadow-lg);
        }

        .toast.error {
            background: #fff;
            border: 1px solid rgba(196, 93, 62, 0.2);
            color: var(--error);
        }

        .toast.success {
            background: #fff;
            border: 1px solid rgba(90, 138, 106, 0.2);
            color: var(--success);
        }

        /* ── Empty State ─────────────────────────────── */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state p {
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        /* ── Utilities ───────────────────────────────── */
        .hidden { display: none !important; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(4px); }
        }
    </style>
</head>

<body>

    <!-- NAV — always visible -->
    <nav>
        <div class="logo">MARKT</div>
        <div class="nav-right">
            <!-- Shown when logged in -->
            <div class="nav-user hidden" id="navUser">
                <strong id="navUsername"></strong>
            </div>
            <div class="cart-badge hidden" id="navCart" onclick="toggleCart()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 01-8 0"/>
                </svg>
                <span class="cart-count hidden" id="cartCount">0</span>
            </div>
            <button class="btn btn-ghost btn-sm hidden" id="logoutBtn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- ════════ AUTH PAGE ════════ -->
    <div id="authPage" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Welcome</h1>
                <p>Sign in to start shopping</p>
            </div>
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
                    <button class="auth-tab" onclick="switchTab('register')">Create Account</button>
                </div>

                <div class="form-group">
                    <label for="authUsername">Username</label>
                    <input type="text" id="authUsername" placeholder="Enter username">
                </div>
                <div class="form-group hidden" id="emailGroup">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" id="authSubmitBtn" onclick="submitAuth()">Sign In</button>
            </div>
            <div class="auth-footer" id="authFooter">
                Don't have an account? <a href="#" onclick="switchTab('register'); return false;" style="color: var(--accent); text-decoration: none;">Create one</a>
            </div>
        </div>
    </div>

    <!-- ════════ MAIN APP (after login) ════════ -->
    <div id="appPage" class="hidden">
        <div class="main-container">

            <div class="page-header">
                <h2>Products</h2>
            </div>

            <div class="products-grid" id="productsGrid">
                <div class="empty-state">
                    <p>No products yet. Check back soon.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    /*
    ═══════════════════════════════════════════════════════════════
    CLIENT ARCHITECTURE — Same patterns as polling app
    
        1. CONFIG    — API base URL
        2. STATE     — Single source of truth
        3. API       — HTTP fetch wrapper (replaces WebSocket send)
        4. AUTH      — Login/register logic
        5. RENDERER  — UI updates
        6. UTILITIES — Toast, helpers
    ═══════════════════════════════════════════════════════════════
    */


    // ─── 1. CONFIG ────────────────────────────────────────────
    const API = "";  // Same origin — no prefix needed


    // ─── 2. STATE ─────────────────────────────────────────────
    const state = {
        token: localStorage.getItem("token") || null,
        username: localStorage.getItem("username") || null,
        authMode: "login",
        products: [],
        cart: [],
    };


    // ─── 3. API LAYER ────────────────────────────────────────
    /*
        In polling app we had: send(MSG.VOTE, payload) over WebSocket
        In HTTP we have: api("/products", "GET") over fetch

        Same idea — wrapper function that handles:
        - Adding auth header
        - Parsing JSON response
        - Error handling
    */

    async function api(path, method = "GET", body = null) {
        const headers = { "Content-Type": "application/json" };

        // Attach JWT token if we have one
        if (state.token) {
            headers["Authorization"] = `Bearer ${state.token}`;
        }

        const options = { method, headers };
        if (body) {
            options.body = JSON.stringify(body);
        }

        const response = await fetch(`${API}${path}`, options);
        const data = await response.json();

        if (!response.ok) {
            // FastAPI returns {"detail": "error message"} on errors
            throw new Error(data.detail || "Request failed");
        }

        return data;
    }


    // ─── 4. AUTH ─────────────────────────────────────────────

    function switchTab(mode) {
        state.authMode = mode;
        const tabs = document.querySelectorAll(".auth-tab");
        tabs.forEach(t => t.classList.remove("active"));

        const emailGroup = document.getElementById("emailGroup");
        const btn = document.getElementById("authSubmitBtn");
        const footer = document.getElementById("authFooter");

        if (mode === "register") {
            tabs[1].classList.add("active");
            emailGroup.classList.remove("hidden");
            btn.textContent = "Create Account";
            footer.innerHTML = 'Already have an account? <a href="#" onclick="switchTab(\'login\'); return false;" style="color: var(--accent); text-decoration: none;">Sign in</a>';
        } else {
            tabs[0].classList.add("active");
            emailGroup.classList.add("hidden");
            btn.textContent = "Sign In";
            footer.innerHTML = 'Don\'t have an account? <a href="#" onclick="switchTab(\'register\'); return false;" style="color: var(--accent); text-decoration: none;">Create one</a>';
        }
    }

    async function submitAuth() {
        const username = document.getElementById("authUsername").value.trim();
        const password = document.getElementById("authPassword").value;
        const email = document.getElementById("authEmail").value.trim();

        // Validation
        if (!username || !password) {
            showToast("Username and password are required", "error");
            return;
        }
        if (state.authMode === "register" && !email) {
            showToast("Email is required", "error");
            return;
        }

        try {
            const btn = document.getElementById("authSubmitBtn");
            btn.disabled = true;
            btn.textContent = "Please wait...";

            let data;
            if (state.authMode === "register") {
                data = await api("/auth/register", "POST", { username, email, password });
            } else {
                data = await api("/auth/login", "POST", { username, password });
            }

            // Save auth state
            state.token = data.access_token;
            state.username = username;
            localStorage.setItem("token", data.access_token);
            localStorage.setItem("username", username);

            showToast(state.authMode === "register" ? "Account created!" : "Welcome back!", "success");
            showApp();

        } catch (err) {
            showToast(err.message, "error");
        } finally {
            const btn = document.getElementById("authSubmitBtn");
            btn.disabled = false;
            btn.textContent = state.authMode === "register" ? "Create Account" : "Sign In";
        }
    }

    function logout() {
        state.token = null;
        state.username = null;
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        showAuth();
        showToast("Logged out", "success");
    }

    // Allow Enter key to submit
    document.getElementById("authPassword").addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitAuth();
    });


    // ─── 5. RENDERER ─────────────────────────────────────────

    function showAuth() {
        document.getElementById("authPage").classList.remove("hidden");
        document.getElementById("appPage").classList.add("hidden");
        document.getElementById("navUser").classList.add("hidden");
        document.getElementById("navCart").classList.add("hidden");
        document.getElementById("logoutBtn").classList.add("hidden");
    }

    function showApp() {
        document.getElementById("authPage").classList.add("hidden");
        document.getElementById("appPage").classList.remove("hidden");
        document.getElementById("navUser").classList.remove("hidden");
        document.getElementById("navCart").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");
        document.getElementById("navUsername").textContent = state.username;

        // Load products (will be implemented in Slice 2)
        loadProducts();
    }

    async function loadProducts() {
        try {
            // This endpoint doesn't exist yet — will be built in Slice 2
            // For now it will just show empty state
            state.products = await api("/products");
            renderProducts();
        } catch (err) {
            // Expected to fail until Slice 2 is built
            console.log("Products endpoint not available yet");
        }
    }

    function renderProducts() {
        const grid = document.getElementById("productsGrid");

        if (state.products.length === 0) {
            grid.innerHTML = '<div class="empty-state"><p>No products yet. Check back soon.</p></div>';
            return;
        }

        grid.innerHTML = state.products.map(product => `
            <div class="product-card">
                <div class="product-img-placeholder">
                    ${product.name ? product.name.charAt(0).toUpperCase() : "?"}
                </div>
                <div class="product-name">${escapeHtml(product.name)}</div>
                <div class="product-price">$${product.price.toFixed(2)}</div>
                <div class="product-stock">${product.stock} in stock</div>
                <button class="btn btn-accent btn-sm" onclick="addToCart(${product.id})"
                    ${product.stock === 0 ? "disabled" : ""}>
                    ${product.stock === 0 ? "Out of Stock" : "Add to Cart"}
                </button>
            </div>
        `).join("");
    }

    // Placeholder for Slice 3
    function addToCart(productId) {
        showToast("Cart feature coming in Slice 3", "success");
    }

    function toggleCart() {
        showToast("Cart feature coming in Slice 3", "success");
    }


    // ─── 6. UTILITIES ────────────────────────────────────────

    function showToast(message, type = "error") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function escapeHtml(str) {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
    }


    // ─── INIT ─────────────────────────────────────────────────
    if (state.token) {
        showApp();
    } else {
        showAuth();
    }
    </script>
</body>
</html>